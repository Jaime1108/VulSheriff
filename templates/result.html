{% extends 'base.html' %}
{% block content %}

{% set severity_order = severity_order or ['Critical', 'High', 'Medium', 'Low'] %}

{% macro remediation_list(text) -%}
  {% if text %}
    {% set lines = text.splitlines() %}
    {% set ns = namespace(as_list=true) %}
    {% for line in lines %}
      {% set trimmed = line.strip() %}
      {% if trimmed and not (trimmed.startswith('- ') or trimmed.startswith('* ')) %}
        {% set ns.as_list = false %}
      {% endif %}
    {% endfor %}
    {% if ns.as_list %}
      <ul class="text-list">
        {% for line in lines %}
          {% set trimmed = line.strip() %}
          {% if trimmed %}
            {% if trimmed.startswith('- ') or trimmed.startswith('* ') %}
              {% set trimmed = trimmed[2:] %}
            {% endif %}
            <li>{{ trimmed }}</li>
          {% endif %}
        {% endfor %}
      </ul>
    {% else %}
      <div class="text-block">{{ text | replace('\n', '<br>') | safe }}</div>
    {% endif %}
  {% else %}
    <p class="text-muted">Not provided.</p>
  {% endif %}
{%- endmacro %}


{% if status_message %}
  <div class="status-banner">{{ status_message }}</div>
{% endif %}

<section class="report-summary">
  <h1>Security Review Results</h1>
  {% if scan_meta %}
    <div class="report-meta">
      {% if scan_meta.prompt_only %}
        Prompt-only scan Â·
      {% endif %}
      Scanned {{ scan_meta.files_included }} file{{ 's' if scan_meta.files_included != 1 else '' }}
      Â· {{ scan_meta.text_size }}
      Â· Model {{ scan_meta.model_used }}
      Â· {{ scan_meta.elapsed_human }}
      Â· {{ scan_meta.timestamp }}
  {% endif %}

  <div class="severity-pills">
    <span class="severity-pill critical">
      Critical
      <span class="count">{{ severity_counts.get('Critical', 0) }}</span>
    </span>
    <span class="severity-pill high">
      High
      <span class="count">{{ severity_counts.get('High', 0) }}</span>
    </span>
    <span class="severity-pill medium">
      Medium
      <span class="count">{{ severity_counts.get('Medium', 0) }}</span>
    </span>
    <span class="severity-pill low">
      Low
      <span class="count">{{ severity_counts.get('Low', 0) }}</span>
    </span>
  </div>

  {% if report and report.summary %}
    <div class="summary-text">{{ report.summary | replace('\n', '<br>') | safe }}</div>
  {% elif not status_message %}
    <div class="summary-text text-muted">No executive summary was provided by the model.</div>
  {% endif %}
</section>

{% if report %}
  <section class="findings-stack">
      {% if total_findings == 0 %}
        <div class="no-findings">
          No vulnerabilities were reported in the structured JSON for this scan.
        </div>
      {% endif %}
      {% set card_counter = namespace(idx=0, code=0) %}

      {% for sev in severity_order %}
        {% for finding in grouped_findings.get(sev, []) %}
          {% set anchor_id = 'finding-' ~ card_counter.idx %}
          <article class="finding-card {{ sev|lower }}" id="{{ anchor_id }}">
            <div class="finding-top">
              <span class="severity-badge {{ sev|lower }}">{{ finding.severity }}</span>
              <h2 class="finding-title">{{ finding.title }}</h2>
            </div>
            <div class="finding-meta">
              {% if finding.category %}<span><strong>Category:</strong> {{ finding.category }}</span>{% endif %}
              {% if finding.cve_id %}<span><strong>CVE:</strong> {{ finding.cve_id }}</span>{% endif %}
              {% if finding.cvss_score %}<span><strong>CVSS:</strong> {{ finding.cvss_score }}</span>{% endif %}
            </div>
            {% if finding.files %}
              <div class="file-chips mb-3">
                {% for file in finding.files %}
                  <span class="file-chip">{{ file }}</span>
                {% endfor %}
              </div>
            {% endif %}
            {% if finding.description %}
              <div class="finding-section">
                <h4>Why it matters</h4>
                <div class="text-block">{{ finding.description | replace('\n', '<br>') | safe }}</div>
              </div>
            {% endif %}

            {% if finding.evidence %}
              {% set evidence_code_id = 'code-' ~ card_counter.code %}
              {% set card_counter.code = card_counter.code + 1 %}
              <div class="collapsible">
                <button class="collapsible-trigger" type="button" data-toggle="collapsible" data-target="section-{{ evidence_code_id }}" aria-expanded="false">
                  <span>Evidence</span>
                  <span class="chevron">âŒ„</span>
                </button>
                <div class="collapsible-content" id="section-{{ evidence_code_id }}">
                  <div class="copy-row">
                    <button class="copy-btn" type="button" data-copy-target="{{ evidence_code_id }}">ðŸ“‹ Copy snippet</button>
                  </div>
                  <pre><code id="{{ evidence_code_id }}">{{ finding.evidence }}</code></pre>
                </div>
              </div>
            {% endif %}

            {% if finding.remediation %}
              <div class="finding-section">
                <h4>Recommended fix</h4>
                {{ remediation_list(finding.remediation) }}
              </div>
            {% endif %}

            {# Patch section intentionally removed to conserve tokens #}
          </article>
          {% set card_counter.idx = card_counter.idx + 1 %}
        {% endfor %}
      {% endfor %}

      {% for finding in other_findings %}
        {% set anchor_id = 'finding-' ~ card_counter.idx %}
        <article class="finding-card {{ finding.severity|lower }}" id="{{ anchor_id }}">
          <div class="finding-top">
            <span class="severity-badge {{ finding.severity|lower }}">{{ finding.severity }}</span>
            <h2 class="finding-title">{{ finding.title }}</h2>
          </div>
          <div class="finding-meta">
            {% if finding.category %}<span><strong>Category:</strong> {{ finding.category }}</span>{% endif %}
            {% if finding.cve_id %}<span><strong>CVE:</strong> {{ finding.cve_id }}</span>{% endif %}
            {% if finding.cvss_score %}<span><strong>CVSS:</strong> {{ finding.cvss_score }}</span>{% endif %}
          </div>
          {% if finding.files %}
            <div class="file-chips mb-3">
              {% for file in finding.files %}
                <span class="file-chip">{{ file }}</span>
              {% endfor %}
            </div>
          {% endif %}
          {% if finding.description %}
            <div class="finding-section">
              <h4>Why it matters</h4>
              <div class="text-block">{{ finding.description | replace('\n', '<br>') | safe }}</div>
            </div>
          {% endif %}
          {% if finding.remediation %}
            <div class="finding-section">
              <h4>Recommended fix</h4>
              {{ remediation_list(finding.remediation) }}
            </div>
          {% endif %}
        </article>
        {% set card_counter.idx = card_counter.idx + 1 %}
      {% endfor %}
    </section>
{% endif %}

<div class="mt-4 d-flex gap-3">
  <a class="btn btn-primary" href="{{ url_for('index') }}">Run another analysis</a>
  <button class="btn btn-outline-secondary" type="button" onclick="history.back()">Back</button>
</div>

{% endblock %}
